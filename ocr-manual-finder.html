<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Military Manual Finder - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .processing { animation: pulse 2s infinite; }
        .success-flash { animation: successFlash 2s ease-out; }
        .touch-target { min-height: 44px; }
        .compact-badge {
          font-size: 0.75rem;
          padding: 0.25rem 0.5rem;
          line-height: 1.2;
        }
        .mobile-btn {
          min-height: 44px;
          touch-action: manipulation;
        }
        
        @keyframes successFlash {
            0% { background-color: #f0f9ff; border-color: #3b82f6; }
            50% { background-color: #dcfce7; border-color: #10b981; }
            100% { background-color: #f0f9ff; border-color: #3b82f6; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @media (max-width: 640px) {
            .container-mobile {
                padding: 1rem;
            }
            .mobile-compact {
              padding: 1rem;
            }
            .mobile-text-sm {
              font-size: 0.875rem;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-gray-100">
    <div class="max-w-6xl mx-auto p-2 sm:p-4">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-4 lg:p-8 mb-4 lg:mb-8 border border-gray-200">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex items-center gap-3 lg:gap-4">
                    <div class="bg-blue-600 p-2 lg:p-3 rounded-lg">
                        <span class="text-white text-xl lg:text-2xl">üéØ</span>
                    </div>
                    <div>
                        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">Military Manual Finder</h1>
                    </div>
                </div>

            </div>
        </div>

        <!-- Status Display -->
        <div id="statusAlert" class="hidden mb-4 lg:mb-6">
            <div class="flex items-start gap-3 p-4 rounded-lg">
                <span id="statusIcon" class="text-xl mt-0.5"></span>
                <div class="flex-1">
                    <p id="statusText" class="font-medium"></p>
                    <button onclick="hideStatus()" class="text-sm opacity-75 hover:opacity-100 mt-1">Close</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-1 space-y-4 lg:space-y-6">
                <!-- System Status -->
                <div class="bg-white rounded-xl shadow-lg p-4 lg:p-6 border border-gray-200">
                    <h2 class="text-lg lg:text-xl font-semibold mb-4 flex items-center gap-3">
                        <span class="text-blue-600 text-xl">üñ•Ô∏è</span>
                        System Status
                    </h2>
                    
                    <div id="serverChecking" class="text-center py-4">
                        <div class="text-3xl lg:text-4xl mb-3 processing">üîç</div>
                        <p class="text-blue-800 font-medium text-sm lg:text-base">Checking search system...</p>
                        <p class="text-blue-600 text-xs lg:text-sm mt-1">Connecting to server</p>
                    </div>
                    
                    <div id="serverReady" class="hidden text-center py-4">
                        <div class="text-3xl lg:text-4xl mb-3">‚úÖ</div>
                        <p class="text-green-700 font-medium text-sm lg:text-base">Search System Ready!</p>
                        <p class="text-green-600 text-xs lg:text-sm mt-1" id="serverInfo">Enhanced mapping database enabled</p>
                    </div>
                    
                    <div id="serverError" class="hidden text-center py-4">
                        <div class="text-3xl lg:text-4xl mb-3">‚ùå</div>
                        <p class="text-red-700 font-medium text-sm lg:text-base">System Connection Failed</p>
                        <p class="text-red-600 text-xs lg:text-sm mt-1" id="serverErrorDetails">Please ensure server is running</p>
                        <button onclick="checkServerStatus()" class="mt-3 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors touch-target">
                            üîÑ Retry Connection
                        </button>
                    </div>

                    <div id="ocrProcessing" class="hidden">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="text-blue-600 text-xl processing">‚ö°</span>
                            <span class="font-semibold text-blue-900 text-sm lg:text-base">Processing OCR</span>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between text-xs lg:text-sm">
                                <span id="progressStatus" class="text-blue-800">Uploading image...</span>
                                <span id="progressPercent" class="text-blue-600 font-medium">0%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Upload -->
                <div class="bg-white rounded-xl shadow-lg p-4 lg:p-6 border border-gray-200">
                    <h2 class="text-lg lg:text-xl font-semibold mb-4 lg:mb-6 flex items-center gap-3">
                        <span class="text-blue-600 text-xl">üì∑</span>
                        Image Upload
                    </h2>
                    
                    <div id="uploadArea" onclick="triggerFileInput()" 
                         class="border-2 border-dashed border-gray-300 rounded-xl p-4 sm:p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all group">
                        <div class="text-2xl sm:text-4xl mb-2 sm:mb-4 group-hover:scale-110 transition-transform">üì§</div>
                        <p class="text-base sm:text-lg font-medium text-gray-700 mb-1 sm:mb-2">Upload Equipment Photo</p>
                        <p class="text-xs sm:text-sm text-gray-500">JPG, PNG - Max 10MB</p>
                        <p class="text-xs text-gray-400 mt-1 sm:mt-2 hidden sm:block">Click to select or drag image here</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">

                    <!-- Image Display -->
                    <div id="imageDisplay" class="mt-4 lg:mt-6 hidden">
                        <h3 class="font-semibold text-gray-900 mb-3">üì∏ Uploaded Image</h3>
                        <div>
                            <img id="uploadedImage" class="w-full h-24 lg:h-32 object-cover rounded-lg border shadow-sm">
                        </div>
                        <button onclick="clearImages()" class="mt-3 text-red-600 hover:text-red-800 text-sm font-medium">
                            üóëÔ∏è Clear Image
                        </button>
                    </div>
                </div>

                <!-- Equipment Information -->
                <div class="bg-white rounded-xl shadow-lg p-4 lg:p-6 border border-gray-200">
                    <h3 class="text-lg lg:text-xl font-semibold mb-4 lg:mb-6 flex items-center gap-3">
                        <span class="text-blue-600 text-xl">üìÑ</span>
                        Equipment Information
                    </h3>
                    <div class="space-y-4 lg:space-y-5">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                üìã TM Number (Priority Search)
                            </label>
                            <div class="relative">
                                <input type="text" id="tmInput" placeholder="e.g.: 9-6115-749-10"
                                       class="w-full px-4 py-3 text-base sm:text-sm pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <button onclick="clearInput('tmInput')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 text-lg touch-target">
                                    ‚úï
                                </button>
                            </div>
                            <p class="text-xs text-green-600 mt-1">‚úÖ Will search TM first if provided</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                üè∑Ô∏è Model Number (Enhanced Mapping)
                            </label>
                            <div class="relative">
                                <input type="text" id="modelInput" placeholder="e.g.: MEP-804A, M200A/P"
                                       class="w-full px-4 py-3 text-base sm:text-sm pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <button onclick="clearInput('modelInput')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 text-lg touch-target">
                                    ‚úï
                                </button>
                            </div>
                            <p class="text-xs text-orange-600 mt-1">‚ö†Ô∏è Used only if TM number not provided</p>
                        </div>
                        
                        <!-- Single Search Button -->
                        <button onclick="clearAll()" class="w-full sm:w-auto bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors touch-target">
                            üîÑ Clear All
                        </button>
                        <button onclick="smartSearch()" class="w-full bg-blue-600 text-white py-4 px-6 rounded-lg hover:bg-blue-700 transition-all font-semibold shadow-md flex items-center justify-center gap-3 text-base sm:text-lg touch-target">
                            <span>üîç</span>
                            <span class="hidden sm:inline">Enhanced </span>Smart Search
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-2 space-y-4 lg:space-y-6">
                <!-- Extracted Information -->
                <div id="extractedInfo" class="hidden bg-white rounded-xl shadow-lg p-4 lg:p-6 border border-gray-200">
                    <h3 class="text-lg lg:text-xl font-semibold mb-4 flex flex-wrap items-center gap-3">
                        <span class="text-green-600 text-xl">‚ú®</span>
                        <span>Extracted Equipment Information</span>
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">Azure OCR</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-900 mb-2">üìã TM Number</h4>
                            <p id="extractedTM" class="text-blue-800 font-mono text-sm">Not detected</p>
                        </div>
                        <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-900 mb-2">üè∑Ô∏è Model Number</h4>
                            <p id="extractedModel" class="text-green-800 font-mono text-sm">Not detected</p>
                        </div>
                    </div>
                    <div class="mt-4 bg-gray-50 border border-gray-200 p-3 rounded-lg">
                        <p class="text-xs lg:text-sm text-gray-600">
                            <span class="font-semibold">Processing Time:</span> <span id="processingTime">-</span> | 
                            <span class="font-semibold">Recognition Status:</span> <span id="recognitionStatus">Pending</span>
                        </p>
                    </div>
                </div>

                <!-- Search Results -->
                <div class="bg-white rounded-xl shadow-lg p-4 lg:p-6 border border-gray-200">
                    <h2 class="text-lg lg:text-xl font-semibold mb-4 lg:mb-6 flex flex-wrap items-center gap-3">
                        <span class="text-blue-600 text-xl">üìö</span>
                        <span>Search Results</span>
                        <span id="resultCount" class="hidden bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium"></span>
                        <span id="searchMethod" class="hidden bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium"></span>
                    </h2>

                    <div id="noResults" class="text-center py-8 lg:py-16 text-gray-500">
                        <div class="text-4xl lg:text-6xl mb-4 lg:mb-6">üîç</div>
                        <h3 class="text-base lg:text-lg font-medium text-gray-900 mb-2">Ready for Enhanced Search</h3>
                        <p class="text-sm lg:text-base">Upload equipment nameplate image or enter TM/Model information, then click Enhanced Smart Search</p>
                    </div>

                    <div id="searchResults" class="space-y-4 lg:space-y-6 hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const OCR_SERVER_URL = "https://web-production-104d0.up.railway.app";
        let isServerReady = false;

        // Clear input function
        function clearInput(inputId) {
            document.getElementById(inputId).value = '';
        }

        // Check server status
        async function checkServerStatus() {
            try {
                showServerChecking();
                
                const response = await fetch(`${OCR_SERVER_URL}/health`);
                if (response.ok) {
                    const data = await response.json();
                    isServerReady = true;
                    showServerReady(data);
                } else {
                    throw new Error('Server response error');
                }
            } catch (error) {
                console.error('Server check failed:', error);
                showServerError(error.message);
            }
        }

        // Handle image upload
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!isServerReady) {
                showStatus('‚ö†Ô∏è', 'System not ready, please wait for server startup.', 'warning');
                return;
            }

            if (!file.type.startsWith('image/')) {
                showStatus('‚ùå', 'Please select a valid image file.', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showStatus('‚ùå', 'Image file too large, please select an image smaller than 10MB.', 'error');
                return;
            }

            clearPreviousResults();
            showImageDisplay(file);
            await performOCR(file);
        }

        // Clear previous results and show searching state
        function clearPreviousResults() {
            document.getElementById('tmInput').value = '';
            document.getElementById('modelInput').value = '';
            document.getElementById('extractedInfo')?.classList.add('hidden');
            document.getElementById('searchResults')?.classList.add('hidden');
            document.getElementById('noResults')?.classList.remove('hidden');
            document.getElementById('resultCount')?.classList.add('hidden');
            document.getElementById('searchMethod')?.classList.add('hidden');
        }

        // Show uploaded image
        function showImageDisplay(file) {
            const uploadedImg = document.getElementById('uploadedImage');
            const imageDisplay = document.getElementById('imageDisplay');
            
            if (uploadedImg && imageDisplay) {
                uploadedImg.src = URL.createObjectURL(file);
                imageDisplay.classList.remove('hidden');
            }
        }

        // Perform OCR
        async function performOCR(file) {
            try {
                console.log('Starting Azure OCR processing...');
                showOcrProcessing();
                updateProgress(10, 'Preparing image upload...');

                const formData = new FormData();
                formData.append('file', file);

                updateProgress(30, 'Uploading...');

                const response = await fetch(`${OCR_SERVER_URL}/extract`, {
                    method: 'POST',
                    body: formData
                });

                updateProgress(80, 'Processing OCR results...');

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Server processing error');
                }

                const data = await response.json();
                console.log('OCR results:', data);

                updateProgress(90, 'Extracting equipment information...');

                showExtractedInfo(data);

                if (data.tm) {
                    const tmInput = document.getElementById('tmInput');
                    if (tmInput) {
                        tmInput.value = data.tm;
                        tmInput.classList.add('success-flash');
                        setTimeout(() => tmInput.classList.remove('success-flash'), 2000);
                    }
                }
                
                if (data.model) {
                    const modelInput = document.getElementById('modelInput');
                    if (modelInput) {
                        modelInput.value = data.model;
                        modelInput.classList.add('success-flash');
                        setTimeout(() => modelInput.classList.remove('success-flash'), 2000);
                    }
                }

                updateProgress(100, 'OCR Complete!');

                if (data.found) {
                    showStatus('‚úÖ', `Successfully extracted: TM: ${data.tm || 'Not found'}, Model: ${data.model || 'Not found'}`, 'success');
                    
                    // Auto search after OCR
                    setTimeout(() => smartSearch(), 1000);
                } else {
                    showStatus('‚ö†Ô∏è', 'Could not extract equipment information. Please enter manually.', 'warning');
                }

                setTimeout(hideOcrProcessing, 3000);

            } catch (error) {
                console.error('OCR Error:', error);
                showStatus('‚ùå', 'OCR recognition failed: ' + error.message, 'error');
                hideOcrProcessing();
            }
        }

        // Smart search - main search function with streaming results
        async function smartSearch() {
            const tm = document.getElementById('tmInput')?.value.trim() || '';
            const model = document.getElementById('modelInput')?.value.trim() || '';

            if (!tm && !model) {
                showStatus('‚ö†Ô∏è', 'Please enter TM number or model number.', 'warning');
                return;
            }

            // Show searching state immediately
            showSearchingState(tm, model);

            await performSmartSearch(tm, model);
        }

        // Show initial searching state with real-time status updates
        function showSearchingState(tm, model) {
            let searchStrategy = '';
            if (tm && model) {
                searchStrategy = 'TM number priority, model as backup';
            } else if (tm) {
                searchStrategy = 'TM number only';
            } else {
                searchStrategy = 'Enhanced model search with mapping';
            }

            const container = document.getElementById('searchResults');
            const noResults = document.getElementById('noResults');
            
            noResults?.classList.add('hidden');
            container?.classList.remove('hidden');
            
            container.innerHTML = `
                <div class="border border-blue-200 rounded-xl p-6 bg-blue-50 search-status">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-blue-600 text-xl processing">üîç</span>
                        <span class="font-semibold text-blue-900">Real-time Search in Progress...</span>
                    </div>
                    <div class="space-y-2">
                        <p class="text-blue-800"><strong>Strategy:</strong> ${searchStrategy}</p>
                        <p class="text-blue-700 status-message">Initializing search...</p>
                        <div class="mt-4">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-blue-800">Status</span>
                                <span class="text-blue-600">Connecting...</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300 processing" style="width: 20%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Add result to existing results (for streaming)
        function addSearchResult(result, isFirst = false) {
            const container = document.getElementById('searchResults');
            
            if (isFirst) {
                container.innerHTML = ''; // Clear searching state
            }
            
            const resultHTML = `
                <div class="border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all bg-gradient-to-br from-white to-gray-50">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="bg-white rounded-lg shadow-sm p-4">
                                <h3 class="font-bold text-gray-900 text-lg">${result.title}</h3>
                                <div class="flex items-center gap-2 mb-4">
                                  <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">
                                    ${result.confidence}% match
                                  </span>
                                  ${result.verified ? 
                                    '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">‚úì Verified</span>' : ''
                                  }
                                  ${result.source ? 
                                    `<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-semibold">${result.source}</span>` : ''
                                  }
                                </div>
                            </div>
                            ${result.title_suffix ? `<p class="text-gray-700 mb-4 leading-relaxed">${result.title_suffix}</p>` : ''}
                            ${result.method==='google_site_search' ? `<p class="text-gray-700 mb-4 leading-relaxed">${result.description}</p>` : ''}
                        </div>
                    </div>
                    ${result.isPdfResult ? `
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="window.open('${result.url}', '_blank')" 
                                    class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center gap-2 shadow-md">
                                <span>üìñ</span>
                                Open PDF
                            </button>
                            <button onclick="copyToClipboard('${result.url}')" 
                                    class="bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors font-medium flex items-center justify-center gap-2">
                                <span>üìã</span>
                                Copy Link
                            </button>
                        </div>
                    ` : `
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-blue-600 text-lg">üîç</span>
                                <span class="font-semibold text-gray-900">Manual Search Required</span>
                            </div>
                            <p class="text-gray-700 text-sm">
                                Click to search manually.
                            </p>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="window.open('${result.url}', '_blank')" 
                                    class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center justify-center gap-2 shadow-md">
                                <span>üîç</span>
                                Search Manually
                            </button>
                        </div>
                    `}
                </div>
            `;
            
            container.innerHTML += resultHTML;
        }

        // Perform smart search with simplified streaming
        async function performSmartSearch(tm, model) {
            try {
                showStatus('üîç', 'Starting enhanced smart search...', 'info');
                                
                // Use fixed streaming endpoint
                const response = await fetch(`${OCR_SERVER_URL}/search-stream-fixed`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tm: tm,
                        model: model
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                // Handle Server-Sent Events stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let resultCount = 0;
                let buffer = '';

                console.log('üîÑ Starting to read stream...');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        console.log('‚úÖ Stream reading complete');
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                console.log('üì° Received:', data);
                                
                                switch (data.type) {
                                    case 'start':
                                        console.log('üöÄ Search started');
                                        break;
                                        
                                    case 'status':
                                        console.log('üìä Status:', data.message);
                                        updateSearchStatus(data.message);
                                        break;
                                        
                                    case 'result':
                                        console.log('üìÑ Got result:', data.data.title);
                                        addSearchResult(data.data, resultCount === 0);
                                        resultCount++;
                                        updateResultCount(resultCount);
                                        break;
                                        
                                    case 'complete':
                                        console.log('‚úÖ Search complete:', data);
                                        // Ê£ÄÊü•ÊòØÂê¶ÁúüÁöÑÊúâÁªìÊûú
                                        if (resultCount > 0 || (data.data && data.data.success)) {
                                            showStatus('‚úÖ', data.message || `Found ${resultCount} manual(s)!`, 'success');
                                        } else {
                                            // Âè™ÊúâÂú®ÁúüÁöÑÊ≤°ÊúâÁªìÊûúÊó∂ÊâçÊòæÁ§∫fallback
                                            showManualSearchFallback(tm, model, 'No results found in databases');
                                            showStatus('‚ö†Ô∏è', 'No direct results found, showing manual search options', 'warning');
                                        }
                                        updateSearchMethod('Real-time Stream Search');
                                        break;
                                        
                                    case 'error':
                                        throw new Error(data.message);
                                }
                            } catch (parseError) {
                                console.warn('Failed to parse SSE data:', parseError, 'Line:', line);
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('Stream search error:', error);
                showManualSearchFallback(tm, model, 'Search failed: ' + error.message);
                showStatus('‚ùå', `Search failed: ${error.message}`, 'error');
            }
        }

        // Update search status in real-time
        function updateSearchStatus(message) {
            const container = document.getElementById('searchResults');
            const statusDiv = container.querySelector('.search-status');
            
            if (statusDiv) {
                statusDiv.querySelector('.status-message').textContent = message;
            }
        }

        // Update result count
        function updateResultCount(count) {
            const resultCount = document.getElementById('resultCount');
            if (resultCount) {
                resultCount.textContent = `${count} result${count !== 1 ? 's' : ''}`;
                resultCount.classList.remove('hidden');
            }
        }

        // Update search method indicator
        function updateSearchMethod(method) {
            const searchMethod = document.getElementById('searchMethod');
            if (searchMethod) {
                searchMethod.textContent = method;
                searchMethod.classList.remove('hidden');
            }
        }

        // Show manual search fallback
        function showManualSearchFallback(tm, model, reason) {
            const query = tm ? `TM ${tm}` : model;
            
            const fallbackHTML = `
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-3">
                        <span class="text-yellow-600 text-xl">üîç</span>
                        Manual Search Required
                    </h3>
                    
                    <div class="bg-white border rounded-lg p-4 mb-4">
                        <p class="text-gray-700 mb-3">
                            Try these manual searches for "${query}":
                        </p>
                        
                        <div class="grid md:grid-cols-2 gap-3">
                            <button onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(`${query} filetype:pdf`)}', '_blank')" 
                                    class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center justify-center gap-2">
                                <span>üîç</span>
                                Google Search
                            </button>
                            <button onclick="window.open('https://www.liberatedmanuals.com/search?q=${encodeURIComponent(query)}', '_blank')" 
                                    class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center gap-2">
                                <span>üìö</span>
                                Liberated Manuals
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('searchResults');
            if (container) {
                container.innerHTML = fallbackHTML;
                container.classList.remove('hidden');
                document.getElementById('noResults')?.classList.add('hidden');
            }
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus('üìã', 'Link copied to clipboard!', 'success');
            }).catch(() => {
                showStatus('‚ùå', 'Failed to copy link', 'error');
            });
        }

        // UI Helper Functions
        function showStatus(icon, message, type) {
            const statusAlert = document.getElementById('statusAlert');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            
            if (statusAlert && statusIcon && statusText) {
                statusIcon.textContent = icon;
                statusText.textContent = message;
                
                statusAlert.className = `mb-6 rounded-lg ${
                    type === 'success' ? 'bg-green-50 border border-green-200' :
                    type === 'warning' ? 'bg-yellow-50 border border-yellow-200' :
                    type === 'error' ? 'bg-red-50 border border-red-200' :
                    'bg-blue-50 border border-blue-200'
                }`;
                statusAlert.classList.remove('hidden');
            }
        }

        function hideStatus() {
            document.getElementById('statusAlert')?.classList.add('hidden');
        }

        function showServerChecking() {
            document.getElementById('serverChecking')?.classList.remove('hidden');
            document.getElementById('serverReady')?.classList.add('hidden');
            document.getElementById('serverError')?.classList.add('hidden');
        }

        function showServerReady(serverData) {
            document.getElementById('serverChecking')?.classList.add('hidden');
            document.getElementById('serverError')?.classList.add('hidden');
            document.getElementById('serverReady')?.classList.remove('hidden');
            
            const serverInfo = document.getElementById('serverInfo');
            if (serverInfo && serverData) {
                serverInfo.textContent = `${serverData.service || 'Enhanced Search System'} ready - ${serverData.model_mappings || 0} model mappings loaded`;
            }
        }

        function showServerError(message) {
            document.getElementById('serverChecking')?.classList.add('hidden');
            document.getElementById('serverReady')?.classList.add('hidden');
            document.getElementById('serverError')?.classList.remove('hidden');
            
            const errorDetails = document.getElementById('serverErrorDetails');
            if (errorDetails) {
                errorDetails.textContent = message || 'Please ensure enhanced search server is running on localhost:3000';
            }
        }

        function showOcrProcessing() {
            document.getElementById('serverReady')?.classList.add('hidden');
            document.getElementById('ocrProcessing')?.classList.remove('hidden');
        }

        function hideOcrProcessing() {
            document.getElementById('ocrProcessing')?.classList.add('hidden');
            document.getElementById('serverReady')?.classList.remove('hidden');
        }

        function updateProgress(percent, status) {
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressStatus').textContent = status;
            document.getElementById('progressBar').style.width = percent + '%';
        }

        function showExtractedInfo(data) {
            document.getElementById('extractedTM').textContent = data.tm || 'Not detected';
            document.getElementById('extractedModel').textContent = data.model || 'Not detected';
            document.getElementById('processingTime').textContent = data.processing_time + 's' || '-';
            document.getElementById('recognitionStatus').textContent = data.found ? 'Recognition successful' : 'Not recognized';
            document.getElementById('extractedInfo')?.classList.remove('hidden');
        }

        function triggerFileInput() {
            if (!isServerReady) {
                showStatus('‚ö†Ô∏è', 'Please wait for system startup to complete.', 'warning');
                return;
            }
            document.getElementById('fileInput')?.click();
        }

        function clearImages() {
            document.getElementById('imageDisplay')?.classList.add('hidden');
            document.getElementById('fileInput').value = '';
        }

        function clearAll() {
            document.getElementById('tmInput').value = '';
            document.getElementById('modelInput').value = '';
            clearImages();
            document.getElementById('extractedInfo')?.classList.add('hidden');
            document.getElementById('searchResults')?.classList.add('hidden');
            document.getElementById('noResults')?.classList.remove('hidden');
            document.getElementById('resultCount')?.classList.add('hidden');
            document.getElementById('searchMethod')?.classList.add('hidden');
            hideStatus();
        }

        // Enable drag and drop
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (isServerReady) {
                    uploadArea.classList.add('border-blue-400', 'bg-blue-50');
                }
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                
                if (!isServerReady) {
                    showStatus('‚ö†Ô∏è', 'Please wait for system startup to complete.', 'warning');
                    return;
                }
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        document.getElementById('fileInput').files = files;
                        handleImageUpload({ target: { files: [file] } });
                    }
                }
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced Search App loaded, checking system status...');
            checkServerStatus();
        });

        // Periodic server health check
        setInterval(() => {
            if (!isServerReady) {
                checkServerStatus();
            }
        }, 10000); // Check every 10 seconds if not ready
    </script>
</body>
</html>